@(existingDocentForm: Form[fhs.pages.editdocents.MExistingDocent], houses: List[persistence.location.HouseEntity], rooms: List[persistence.location.RoomEntity], timeRanges:List[models.fhs.pages.generator.TimeRange],allTimeSlots:List[models.persistence.template.TimeSlotTemplate])(implicit flash:Flash)

@import models.fhs.pages.editdocents._
@import models.persistence.enumerations._


@import models.fhs.pages.roomdefinition._

@import helper._
@import helper.twitterBootstrap._

    @defaultDocent = @{
        MExistingDocent(-1, "", List[MDocentTimeWhish](), List[Long](), List[String](), List[Long]())
    }

<form id="editDocentForm" class="form-inline">
    <a class="btn btn-danger btn-sm pull-right" role="button" href="@routes.CEditDocents.deleteDocent(existingDocentForm.value.getOrElse(defaultDocent).id) "><span class="glyphicon glyphicon-remove-circle"></span> </a>
    @inputText(existingDocentForm("id"), '_class -> "hidden")
    @inputText(existingDocentForm("lastName"), '_label -> "Nachname", '_class -> "form-group", '_help -> "")
    <br/>
    <div class="form-group">
        <label class="control-label" for="favoriteFacility">Bevorzugte Gebäude</label>
        <select multiple id="favoriteFacility" name="houseCriterias" title="nichts ausgewählt">

        @for(h <- houses) {
            @defining(existingDocentForm.value.getOrElse( defaultDocent).houseCriterias.count(houseId => houseId.equals(h.getId)) > 0) { isSelected =>
                <option value="@h.getId" @if(isSelected) { selected }>@h.getName </option>
            }
        }
        </select>
    </div>
    <div class="form-group">
        <label for="favoriteRooms" class="control-label">Bevorzugte Räume</label>
        <select multiple id="favoriteRooms" name="roomCrit" data-selected-text-format="count>4" title="nichts ausgewählt">
        @for(r <- rooms) {
            @defining(existingDocentForm.value.getOrElse(defaultDocent).roomCrit.count(_ == r.getId) > 0) { isSelected =>
                <option value="@r.getId" @if(isSelected) { selected }>@r.getHouse.getName @r.getNumber </option>
            }
        }
        </select>
    </div>
    <div class="form-group">
        <label class="control-label" for="favoriteAttributes">Bevorzugte Ausstattung</label>
        <select id="favoriteAttributes" name="roomAttr" multiple title="nichts ausgewählt">
        @for(attr <- MRoomdefintion.ATTRIBUTES) {
            @defining(existingDocentForm.value.getOrElse(defaultDocent).roomAttr.count(_ == attr)>0) { isSelected =>
                <option @if(isSelected){selected } value="@attr">@attr</option>
            }
        }
        </select>
    </div>
    <div id="timeCrits" class="small">

        <div class="table-responsive">
            <table class="table table-bordered table-striped table-condensed">
                <thead>
                    <th class="text-center text-info" >Uhrzeit</th>

                    @existingTimeWishes= @{
                        existingDocentForm.value.getOrElse(defaultDocent).timeslots
                    }

                    @days= @{
                        CTimeslotDefintion.WEEKDAYS.filterNot{
                            case (sortIndexString,dayname)=>
                                val sortIndex=sortIndexString.toInt
                                allTimeSlots.find(_.getParent.getSortIndex == sortIndex).isEmpty
                        }.sortBy(_._1)
                    }

                    @for(day <- days) {
                        <th class="text-info text-center" > @day._2</th>
                    }
                </thead>
                <tbody>
                @for(range<-timeRanges.sorted){
                    <tr>
                        <td class="text-center"  style="vertical-align: middle; width : 8% ; ">
                            @range.toString
                        </td>
                        @for(day <- days) {
                            @defining(existingTimeWishes.filter(w=> range.compare(w)==0 && w.weekday == day._1.toInt)){ wishes=>
                            <td>
                                @if(!allTimeSlots.find(slot=> range.compare(slot) == 0 && slot.getParent.getSortIndex == day._1.toInt).isEmpty){

                                <form class="subform form-inline">
                                <div class="form-group">
                                    <label>
                                      <input class="form-control" name="timerange" type="radio" value="@{""+range.startHour + "-" + range.startMinute + "," + range.stopHour + "-" + range.stopMinute},@day._1,@EDocentTimeKind.WISH" @if(!wishes.isEmpty && wishes.head.timeKind.equals(EDocentTimeKind.WISH.name())){checked} >
                                        Wunsch
                                    </label>
                                    <label>
                                        <input class="form-control" name="timerange" type="radio" value="@{""+range.startHour + "-" + range.startMinute + "," + range.stopHour + "-" + range.stopMinute},@day._1,@EDocentTimeKind.AVAILABLE" @if(!wishes.isEmpty && wishes.head.timeKind.equals(EDocentTimeKind.AVAILABLE.name())){checked}>
                                        Kann
                                    </label>
                                    <label>
                                        <input class="form-control" name="timerange" type="radio" value="@{""+range.startHour + "-" + range.startMinute + "," + range.stopHour + "-" + range.stopMinute},@day._1,N" @if(wishes.isEmpty){checked} >
                                        N
                                    </label>
                                </div>

                                <div class="form-group" >
                                    <label>
                                        <input class="form-control" name="duration" type="radio" value="@EDuration.WEEKLY" @if(wishes.isEmpty || wishes.head.duration.equals(EDuration.WEEKLY.name())){checked}> wöch
                                    </label>
                                    <label>
                                        <input class="form-control" name="duration" type="radio" value="@EDuration.EVEN" @if(!wishes.isEmpty && wishes.head.duration.equals(EDuration.EVEN.name())){checked}> g
                                    </label>
                                    <label>
                                        <input class="form-control" name="duration" type="radio" value="@EDuration.UNEVEN" @if(!wishes.isEmpty && wishes.head.duration.equals(EDuration.UNEVEN.name())){checked}> ug
                                    </label>
                                </div>
                                </form>
                                }
                            </td>
                            }
                        }
                    </tr>
                }
                </tbody>
            </table>
        </div>
@*
    @repeat(existingDocentForm("timeslots"), min = 0) { timeslotCrit =>
        <div class="panel panel-info" id="@timeslotCrit.id">
            <button id="remove_@timeslotCrit.id" role="button" class="pull-right btn btn-sm btn-danger"><span class="glyphicon glyphicon-minus"></span></button>
            <div class="form-group">
                <label class="control-label">Art der Verfügbarkeit</label>
                <div class="form-group">
                    <label>
                        <input type="radio" class="form-control" @if(timeslotCrit("timeKind").value.getOrElse(EDocentTimeKind.AVAILABLE.name()) == EDocentTimeKind.WISH.name()) {
                        checked } name="@timeslotCrit("timeKind").name" value="@EDocentTimeKind.WISH.name()"/>
                        Wunschzeit
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="radio" class="form-control"  @if(timeslotCrit("timeKind").value.getOrElse(EDocentTimeKind.AVAILABLE.name()) == EDocentTimeKind.AVAILABLE.name()) {
                        checked } name="@timeslotCrit("timeKind").name" value="@EDocentTimeKind.AVAILABLE.name()"/>
                        Kannzeit
                    </label>
                </div>
            </div>
            <h4>Beginn:</h4>

            @select(timeslotCrit("startHour"), (0 to 23).toSeq.map(i => (i.toString, i.formatted("%02d"))), '_class -> "form-group ", '_label -> "Stunde", '_help -> "")
            @select(timeslotCrit("startMinute"), (0 to 59 by 5).toSeq.map(i => (i.toString, i.formatted("%02d"))), '_class -> "form-group ", '_label -> "Minute", '_help -> "")

            <h4>Ende:</h4>

            @select(timeslotCrit("stopHour"), (0 to 23).toSeq.map(i => (i.toString, i.formatted("%02d"))), '_class -> "form-group ", '_label -> "Stunde", '_help -> "")
            @select(timeslotCrit("stopMinute"), (0 to 59 by 5).toSeq.map(i => (i.toString, i.formatted("%02d"))), '_class -> "form-group ", '_label -> "Minute", '_help -> "")
            <div class="clearfix"></div>
            @select(timeslotCrit("weekday"), CTimeslotDefintion.WEEKDAYS, '_class -> "form-group", '_label->"Wochentag")

        </div>
        <script>
        $ ( '#remove_@timeslotCrit.id').on('click', function(e){
        $ ( '#@timeslotCrit.id').remove();
        } ) ;
        </script>
    } *@

    </div>
    <br />
    <!--div class="form-group">
        <button type="button" id="addTimeCrit" class="btn btn-sm btn-warning" role="button"><span class="glyphicon glyphicon-plus"></span> </button>
    </div -->
    <div class="clearfix"></div>
    <br />
    <div class="form-group">
        <div class="form-group">
            <button class="form-control btn btn-success" type="submit"> <span class="glyphicon glyphicon-ok"></span> </button>
        </div>
        <div class="form-group">
            <button class="form-control btn btn-danger" type="reset"><span class="glyphicon glyphicon-remove"></span> </button>
        </div>
    </div>

</form>
    @if(flash.get("submitResult").getOrElse("").equals("true")){
    <div class="alert alert-success"> <span class="glyphicon glyphicon-thumbs-up"></span> Erfolg </div>
    }
   @if(flash.get("submitResult").getOrElse("").equals("false")){
    <div class="alert alert-danger"> <span class="glyphicon glyphicon-thumbs-down"></span> Fehler </div>
   }
<script >
 initSelect();

 index=@existingDocentForm.value.getOrElse(defaultDocent).timeslots.length;
    $('#addTimeCrit' ).on('click', function(e){
    $.getJSON('/timeCritFields/' + index, function(data){
      $('#timeCrits' ).append(data.htmlresult);
      initSelect ();
     });

    index++;
});

$ ( '#editDocentForm' ).on ( 'submit', function ( e ) {
e.preventDefault ( ) ;

var postData = $ ( this ).serializeObject() ;

    var timeslotBuffer = [];
    $('.subform' ).each(function(index, value){
        var subFormData = $(value ).serializeObject();

        timeslotBuffer.push ( subFormData )

    });

    timeslotBuffer.push({"timerange" : postData['timerange'], "duration":postData['duration']});
postData['timeslots'] = timeslotBuffer ;

var postUrl = "@routes.CEditDocents.editDocent";

if(postData['roomCrit']==null){
postData['roomCrit']=[];
}
if(! $.isArray(postData['roomCrit'])){
postData['roomCrit']=[postData['roomCrit']];
}

if(postData['houseCriterias']==null){
postData['houseCriterias']=[];
}
if(! $.isArray(postData['houseCriterias'])){
postData['houseCriterias']=[postData['houseCriterias']];
}

if(postData['roomAttr']==null){
postData['roomAttr']=[];
}
if(! $.isArray(postData['roomAttr'])){
postData['roomAttr']=[postData['roomAttr']];
}

var Form = this;

console.log(JSON.stringify(postData));

$.ajax ( {
url : postUrl,
type : "POST",
data :JSON.stringify(postData),
dataType : "json",
context : Form,
contentType : "application/json; charset=utf-8",
success : function ( data) {
$ ( '#docentFields' ).empty ( ).append ( data.htmlresult ) ;
},
error : function ( jqXHR, textStatus, errorThrown ) {
$ ( '#docentFields' ).empty ( ).append ( '<div class="alert alert-danger"> <span class="glyphicon glyphicon-thumbs-down" />' + errorThrown + ' </div> ' )
}
} ) ;

//e.unbind(); //unbind. to stop multiple form submit.
} ) ;
</script>